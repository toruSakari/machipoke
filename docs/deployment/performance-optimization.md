# ãƒãƒãƒã‚± ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ã‚¬ã‚¤ãƒ‰

ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§ã¯ã€ãƒãƒãƒã‚±ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’æœ€é©åŒ–ã™ã‚‹ãŸã‚ã®æˆ¦ç•¥ã¨å…·ä½“çš„ãªå®Ÿè£…æ–¹æ³•ã«ã¤ã„ã¦èª¬æ˜ã—ã¾ã™ã€‚

## ç›®æ¬¡

1. [ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›®æ¨™](#ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›®æ¨™)
2. [ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®æœ€é©åŒ–](#ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®æœ€é©åŒ–)
3. [ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®æœ€é©åŒ–](#ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®æœ€é©åŒ–)
4. [ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®æœ€é©åŒ–](#ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®æœ€é©åŒ–)
5. [ç”»åƒã®æœ€é©åŒ–](#ç”»åƒã®æœ€é©åŒ–)
6. [ã‚­ãƒ£ãƒƒã‚·ãƒ³ã‚°æˆ¦ç•¥](#ã‚­ãƒ£ãƒƒã‚·ãƒ³ã‚°æˆ¦ç•¥)
7. [ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æœ€é©åŒ–](#ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æœ€é©åŒ–)
8. [ãƒ¢ãƒã‚¤ãƒ«æœ€é©åŒ–](#ãƒ¢ãƒã‚¤ãƒ«æœ€é©åŒ–)
9. [ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°](#ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°)
10. [ç¶™ç¶šçš„ãªæœ€é©åŒ–](#ç¶™ç¶šçš„ãªæœ€é©åŒ–)

## ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›®æ¨™

ãƒãƒãƒã‚±ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã¯ã€ä»¥ä¸‹ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›®æ¨™ã‚’è¨­å®šã—ã¦ã„ã¾ã™ï¼š

- **ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚é–“**: åˆå›è¨ªå•æ™‚ã«2ç§’ä»¥å†…ã€å†è¨ªå•æ™‚ã«1ç§’ä»¥å†…
- **Time to Interactive (TTI)**: 3ç§’ä»¥å†…
- **First Contentful Paint (FCP)**: 1.5ç§’ä»¥å†…
- **Largest Contentful Paint (LCP)**: 2.5ç§’ä»¥å†…
- **APIå¿œç­”æ™‚é–“**: 300msä»¥å†…
- **åœ°å›³è¡¨ç¤ºæ™‚é–“**: 1.5ç§’ä»¥å†…

ã“ã‚Œã‚‰ã®ç›®æ¨™ã¯ã€ä»¥ä¸‹ã®æ¸¬å®šç’°å¢ƒã§é”æˆã™ã‚‹ã“ã¨ã‚’ç›®æŒ‡ã—ã¾ã™ï¼š
- ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—: é«˜é€Ÿãƒ–ãƒ­ãƒ¼ãƒ‰ãƒãƒ³ãƒ‰æ¥ç¶š
- ãƒ¢ãƒã‚¤ãƒ«: 4Gæ¥ç¶š
- ãƒ¢ãƒã‚¤ãƒ«ãƒ‡ãƒã‚¤ã‚¹: ä¸­ç´šã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³

## ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®æœ€é©åŒ–

### ã‚³ãƒ¼ãƒ‰åˆ†å‰²

ãƒãƒ³ãƒ‰ãƒ«ã‚µã‚¤ã‚ºã‚’å°ã•ãã™ã‚‹ãŸã‚ã€Reactã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã‚³ãƒ¼ãƒ‰åˆ†å‰²ã‚’å®Ÿè£…ã—ã¾ã™ã€‚

```jsx
// ãƒ«ãƒ¼ãƒˆãƒ™ãƒ¼ã‚¹ã®ã‚³ãƒ¼ãƒ‰åˆ†å‰²
import { lazy, Suspense } from 'react';
import { Loading } from '@/components/common/Loading';

const MapView = lazy(() => import('@/routes/map/page'));
const SpotDetailPage = lazy(() => import('@/routes/spot/[id]/page'));

function App() {
  return (
    <Routes>
      <Route path="/" element={<HomePage />} />
      <Route 
        path="/map" 
        element={
          <Suspense fallback={<Loading />}>
            <MapView />
          </Suspense>
        } 
      />
      <Route 
        path="/spots/:id" 
        element={
          <Suspense fallback={<Loading />}>
            <SpotDetailPage />
          </Suspense>
        } 
      />
    </Routes>
  );
}
```

### JavaScriptæœ€é©åŒ–

ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’å‘ä¸Šã•ã›ã‚‹ãŸã‚ã®JavaScriptæœ€é©åŒ–ï¼š

1. **ãƒãƒ³ãƒ‰ãƒ«ã‚µã‚¤ã‚ºã®æœ€é©åŒ–**:
   - æœªä½¿ç”¨ã‚³ãƒ¼ãƒ‰ã®å‰Šé™¤ï¼ˆTree Shakingï¼‰
   - ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ä¾å­˜é–¢ä¿‚ã®æœ€é©åŒ–

    ```javascript
    // vite.config.ts
    import { defineConfig } from 'vite';
    import react from '@vitejs/plugin-react';
    import { visualizer } from 'rollup-plugin-visualizer';

    export default defineConfig({
      plugins: [
        react(),
        visualizer({ // ãƒãƒ³ãƒ‰ãƒ«ã‚µã‚¤ã‚ºã®åˆ†æ
          open: true,
          filename: 'dist/stats.html',
        }),
      ],
      build: {
        target: 'es2020',
        rollupOptions: {
          output: {
            manualChunks: {
              react: ['react', 'react-dom', 'react-router'],
              mapbox: ['mapbox-gl'],
              ui: ['@/components/ui'],
            },
          },
        },
      },
    });
    ```

2. **ãƒ¡ãƒ¢åŒ–**:

    ```jsx
    // ãƒªã‚¹ãƒˆå†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã®æœ€é©åŒ–
    import React, { memo, useMemo } from 'react';

    const SpotsList = memo(({ spots, onSpotSelect }) => {
      // ã‚¹ãƒãƒƒãƒˆã®ã‚½ãƒ¼ãƒˆã¯å¤‰æ›´ãŒã‚ã£ãŸå ´åˆã®ã¿å®Ÿè¡Œ
      const sortedSpots = useMemo(() => {
        return [...spots].sort((a, b) => a.name.localeCompare(b.name));
      }, [spots]);

      return (
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          {sortedSpots.map(spot => (
            <SpotCard
              key={spot.id}
              spot={spot}
              onClick={onSpotSelect}
            />
          ))}
        </div>
      );
    });
    ```

3. **åŠ¹ç‡çš„ãªã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**:

    ```jsx
    // ã‚¤ãƒ™ãƒ³ãƒˆã®å§”ä»»ã‚’ä½¿ç”¨
    function SpotsList({ spots, onSpotSelect }) {
      const handleClick = (e) => {
        const spotId = e.target.closest('[data-spot-id]')?.dataset.spotId;
        if (spotId) {
          onSpotSelect(spotId);
        }
      };

      return (
        <div className="spots-grid" onClick={handleClick}>
          {spots.map(spot => (
            <div key={spot.id} data-spot-id={spot.id} className="spot-card">
              {/* ã‚¹ãƒãƒƒãƒˆæƒ…å ± */}
            </div>
          ))}
        </div>
      );
    }
    ```

### CSSæœ€é©åŒ–

1. **ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«CSSã®æŠ½å‡º**:

    ```javascript
    // Viteã§ã®ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«CSSè¨­å®š
    import { criticalCss } from 'vite-plugin-critical-css';

    export default defineConfig({
      plugins: [
        react(),
        criticalCss({
          inlineThreshold: 4096,
          penthouse: {
            renderWaitTime: 300,
          },
        }),
      ],
    });
    ```

2. **Tailwindã®æœ€é©åŒ–**:

    ```javascript
    // tailwind.config.js
    module.exports = {
      content: ['./src/**/*.{js,jsx,ts,tsx}'],
      theme: {
        // ãƒ†ãƒ¼ãƒè¨­å®š
      },
      variants: {
        extend: {},
      },
      plugins: [],
      // æœªä½¿ç”¨CSSã®é™¤å»
      purge: {
        enabled: process.env.NODE_ENV === 'production',
        content: ['./src/**/*.{js,jsx,ts,tsx}'],
        options: {
          safelist: [
            // å‹•çš„ã«ä½¿ç”¨ã™ã‚‹ã‚¯ãƒ©ã‚¹ã‚’ã“ã“ã«è¿½åŠ 
            'bg-primary-500',
            'text-primary-500',
          ],
        },
      },
    };
    ```

### SSRã¨ãƒã‚¤ãƒ‰ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æœ€é©åŒ–

React Router v7ã¨Viteã‚’ä½¿ç”¨ã—ãŸSSRæœ€é©åŒ–ï¼š

```tsx
// entry-server.tsx
import React from 'react';
import { useMedia } from '@/hooks/useMedia';
import { Spot } from '@/types/models';

interface SpotHeaderProps {
  spot: Spot;
  isFavorite: boolean;
  onFavoriteToggle: () => void;
}

export const SpotHeader: React.FC<SpotHeaderProps> = ({ 
  spot, 
  isFavorite,
  onFavoriteToggle 
}) => {
  const isMobile = useMedia('(max-width: 640px)');
  
  return (
    <div className="relative">
      {/* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãªç”»åƒã‚µã‚¤ã‚º */}
      <div className="aspect-video md:aspect-[16/9] lg:aspect-[2/1] overflow-hidden relative">
        <img 
          src={spot.thumbnail} 
          alt={spot.name}
          className="w-full h-full object-cover"
          loading="eager" // ãƒ’ãƒ¼ãƒ­ãƒ¼ã‚¤ãƒ¡ãƒ¼ã‚¸ã¯å„ªå…ˆçš„ã«èª­ã¿è¾¼ã¿
        />
      </div>
      
      <div className="container mx-auto px-4">
        <div className={`${isMobile ? 'block' : 'flex justify-between items-end'} -mt-16 relative z-10`}>
          <div className="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-lg mb-4 md:mb-0 flex-1">
            <h1 className="text-2xl md:text-3xl font-bold truncate">{spot.name}</h1>
            <div className="flex flex-wrap gap-2 mt-2">
              <span className="bg-primary-100 text-primary-800 text-sm px-2 py-1 rounded">
                {spot.category}
              </span>
              <span className="bg-gray-100 text-gray-800 text-sm px-2 py-1 rounded">
                {spot.address.prefecture}
              </span>
            </div>
          </div>
          
          {/* ãƒ¢ãƒã‚¤ãƒ«ã§ã¯ä¸‹éƒ¨ã«å›ºå®šã€ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ã§ã¯å³å´ã«é…ç½® */}
          <div className={isMobile ? 'fixed bottom-0 left-0 right-0 bg-white dark:bg-gray-800 p-4 shadow-up z-20' : 'ml-4'}>
            <button 
              onClick={onFavoriteToggle}
              className={`${isMobile ? 'w-full' : 'px-6'} py-2 rounded-full flex items-center justify-center gap-2 ${isFavorite ? 'bg-primary-500 text-white' : 'bg-gray-200 text-gray-800'}`}
            >
              <HeartIcon filled={isFavorite} />
              <span>{isFavorite ? 'ä¿å­˜æ¸ˆã¿' : 'ä¿å­˜ã™ã‚‹'}</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  );
};

// ã‚¢ã‚¤ã‚³ãƒ³ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
const HeartIcon = ({ filled }: { filled: boolean }) => (
  <svg width="20" height="20" viewBox="0 0 20 20" fill={filled ? 'currentColor' : 'none'} stroke="currentColor">
    <path d="M10 17.8l-1.45-1.32C4.2 12.36 1 9.44 1 5.95 1 3.07 3.07 1 5.95 1c1.41 0 2.77.66 3.66 1.66l.39.49.39-.49C11.28 1.66 12.64 1 14.05 1 16.93 1 19 3.07 19 5.95c0 3.49-3.2 6.41-7.55 10.53L10 17.8z" />
  </svg>
);
```

### ãƒ¢ãƒã‚¤ãƒ«ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®æœ€é©åŒ–

```typescript
// src/components/common/TouchOptimized.tsx
import React, { useRef, useEffect } from 'react';

interface TouchOptimizedProps {
  children: React.ReactNode;
  onTap?: () => void;
  tapDelay?: number; // ã‚¿ãƒƒãƒ—æ¤œå‡ºã®é…å»¶ï¼ˆãƒŸãƒªç§’ï¼‰
}

// ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆã‚’æœ€é©åŒ–ã—ã€300msã®é…å»¶ã‚’ãªãã™ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
export const TouchOptimized: React.FC<TouchOptimizedProps> = ({ 
  children, 
  onTap, 
  tapDelay = 0 
}) => {
  const elementRef = useRef<HTMLDivElement>(null);
  const touchStartTimeRef = useRef<number>(0);
  const touchStartPosRef = useRef<{x: number, y: number}>({x: 0, y: 0});
  
  useEffect(() => {
    const element = elementRef.current;
    if (!element || !onTap) return;
    
    const handleTouchStart = (e: TouchEvent) => {
      touchStartTimeRef.current = Date.now();
      touchStartPosRef.current = {
        x: e.touches[0].clientX,
        y: e.touches[0].clientY
      };
    };
    
    const handleTouchEnd = (e: TouchEvent) => {
      // ã‚¿ãƒƒãƒ—ã¨ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’åŒºåˆ¥
      const touchEndPos = {
        x: e.changedTouches[0].clientX,
        y: e.changedTouches[0].clientY
      };
      
      const distanceMoved = Math.sqrt(
        Math.pow(touchEndPos.x - touchStartPosRef.current.x, 2) +
        Math.pow(touchEndPos.y - touchStartPosRef.current.y, 2)
      );
      
      const touchDuration = Date.now() - touchStartTimeRef.current;
      
      // çŸ­ã„æ™‚é–“ã§ã»ã¨ã‚“ã©ç§»å‹•ã—ã¦ã„ãªã„å ´åˆã¯ã‚¿ãƒƒãƒ—ã¨åˆ¤å®š
      if (touchDuration < 300 && distanceMoved < 10) {
        e.preventDefault(); // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã®ç™ºç«ã‚’é˜²æ­¢
        
        if (tapDelay > 0) {
          setTimeout(onTap, tapDelay);
        } else {
          onTap();
        }
      }
    };
    
    element.addEventListener('touchstart', handleTouchStart, { passive: true });
    element.addEventListener('touchend', handleTouchEnd);
    
    return () => {
      element.removeEventListener('touchstart', handleTouchStart);
      element.removeEventListener('touchend', handleTouchEnd);
    };
  }, [onTap, tapDelay]);
  
  return (
    <div ref={elementRef} style={{ touchAction: 'manipulation' }}>
      {children}
    </div>
  );
};
```

### ãƒãƒƒãƒ†ãƒªãƒ¼æ¶ˆè²»ã®æœ€é©åŒ–

```typescript
// src/hooks/useEffectiveAnimation.ts
import { useState, useEffect } from 'react';

// ãƒãƒƒãƒ†ãƒªãƒ¼çŠ¶æ…‹ã‚„é›»æºçŠ¶æ…‹ã«åŸºã¥ã„ã¦ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’èª¿æ•´ã™ã‚‹ãƒ•ãƒƒã‚¯
export function useEffectiveAnimation(defaultEnabled = true) {
  const [animationsEnabled, setAnimationsEnabled] = useState(defaultEnabled);
  
  useEffect(() => {
    // ãƒãƒƒãƒ†ãƒªãƒ¼APIå¯¾å¿œãƒ–ãƒ©ã‚¦ã‚¶ã®å ´åˆ
    if ('getBattery' in navigator) {
      const handleBatteryChange = (battery: any) => {
        // ãƒãƒƒãƒ†ãƒªãƒ¼ãƒ¬ãƒ™ãƒ«ãŒ20%ä»¥ä¸‹ã§ãƒãƒƒãƒ†ãƒªãƒ¼ç¯€ç´„ãƒ¢ãƒ¼ãƒ‰ã‚’æœ‰åŠ¹åŒ–
        if (battery.level <= 0.2 && !battery.charging) {
          setAnimationsEnabled(false);
        } else {
          setAnimationsEnabled(defaultEnabled);
        }
      };
      
      // ãƒãƒƒãƒ†ãƒªãƒ¼çŠ¶æ…‹ã®ç›£è¦–
      (navigator as any).getBattery().then((battery: any) => {
        handleBatteryChange(battery);
        
        battery.addEventListener('levelchange', () => handleBatteryChange(battery));
        battery.addEventListener('chargingchange', () => handleBatteryChange(battery));
        
        return () => {
          battery.removeEventListener('levelchange', () => handleBatteryChange(battery));
          battery.removeEventListener('chargingchange', () => handleBatteryChange(battery));
        };
      });
    }
    
    // ãƒ—ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹å¯¾å¿œãƒ–ãƒ©ã‚¦ã‚¶ã®å ´åˆ
    if ('matchMedia' in window) {
      const reducedMotionQuery = window.matchMedia('(prefers-reduced-motion: reduce)');
      
      if (reducedMotionQuery.matches) {
        setAnimationsEnabled(false);
      }
      
      const handleReducedMotionChange = (e: MediaQueryListEvent) => {
        setAnimationsEnabled(!e.matches);
      };
      
      reducedMotionQuery.addEventListener('change', handleReducedMotionChange);
      
      return () => {
        reducedMotionQuery.removeEventListener('change', handleReducedMotionChange);
      };
    }
  }, [defaultEnabled]);
  
  return animationsEnabled;
}
```

## ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°

### ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°

```typescript
// src/lib/performance.ts
import { getCLS, getFID, getLCP, getFCP, getTTFB } from 'web-vitals';

// Web Vitalsæ¸¬å®šã¨ãƒ¬ãƒãƒ¼ãƒˆ
export function reportWebVitals(onPerfEntry?: (metric: any) => void) {
  if (onPerfEntry && typeof onPerfEntry === 'function') {
    // Core Web Vitalsã®æ¸¬å®š
    getCLS(onPerfEntry);  // Cumulative Layout Shift
    getFID(onPerfEntry);  // First Input Delay
    getLCP(onPerfEntry);  // Largest Contentful Paint
    getFCP(onPerfEntry);  // First Contentful Paint
    getTTFB(onPerfEntry); // Time to First Byte
  }
}

// ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ‡ãƒ¼ã‚¿åé›†
export function collectPerformanceMetrics() {
  if (typeof window !== 'undefined' && 'performance' in window) {
    const navigationTiming = performance.getEntriesByType('navigation')[0] as PerformanceNavigationTiming;
    const paintTimings = performance.getEntriesByType('paint');
    
    // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒŸãƒ³ã‚°ãƒ¡ãƒˆãƒªã‚¯ã‚¹
    const metrics = {
      // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰å…¨ä½“ã®æ™‚é–“
      pageLoadTime: navigationTiming.loadEventEnd - navigationTiming.startTime,
      
      // ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“
      serverResponseTime: navigationTiming.responseStart - navigationTiming.requestStart,
      
      // ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆèª­ã¿è¾¼ã¿æ™‚é–“
      documentLoadTime: navigationTiming.domComplete - navigationTiming.domInteractive,
      
      // First Paint
      firstPaint: 0,
      
      // First Contentful Paint
      firstContentfulPaint: 0,
    };
    
    // ãƒšã‚¤ãƒ³ãƒˆã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’å–å¾—
    paintTimings.forEach((timing) => {
      const paintTiming = timing as PerformancePaintTiming;
      if (paintTiming.name === 'first-paint') {
        metrics.firstPaint = paintTiming.startTime;
      } else if (paintTiming.name === 'first-contentful-paint') {
        metrics.firstContentfulPaint = paintTiming.startTime;
      }
    });
    
    return metrics;
  }
  
  return null;
}

// ãƒªã‚½ãƒ¼ã‚¹èª­ã¿è¾¼ã¿ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åˆ†æ
export function analyzeResourceLoadPerformance() {
  if (typeof window !== 'undefined' && 'performance' in window) {
    const resources = performance.getEntriesByType('resource');
    
    const resourcesByType: Record<string, PerformanceResourceTiming[]> = {};
    
    resources.forEach((resource) => {
      const resourceTiming = resource as PerformanceResourceTiming;
      const url = resourceTiming.name;
      const fileExtension = url.split('.').pop()?.split('?')[0] || 'unknown';
      
      if (!resourcesByType[fileExtension]) {
        resourcesByType[fileExtension] = [];
      }
      
      resourcesByType[fileExtension].push(resourceTiming);
    });
    
    // å„ãƒªã‚½ãƒ¼ã‚¹ã‚¿ã‚¤ãƒ—ã”ã¨ã®çµ±è¨ˆæƒ…å ±ã‚’è¨ˆç®—
    const statistics: Record<string, { count: number, totalSize: number, avgLoadTime: number }> = {};
    
    Object.entries(resourcesByType).forEach(([type, timings]) => {
      const count = timings.length;
      const totalSize = timings.reduce((sum, timing) => sum + (timing.transferSize || 0), 0);
      const totalLoadTime = timings.reduce((sum, timing) => sum + (timing.responseEnd - timing.startTime), 0);
      
      statistics[type] = {
        count,
        totalSize,
        avgLoadTime: count > 0 ? totalLoadTime / count : 0
      };
    });
    
    return statistics;
  }
  
  return null;
}
```

### ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°

```typescript
// src/server/middleware/performance.ts
import { Context } from 'hono';

// ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ¸¬å®šãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢
export function performanceMonitoring() {
  return async (c: Context, next: () => Promise<void>) => {
    const requestStartTime = Date.now();
    const url = c.req.url;
    const method = c.req.method;
    
    // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ˜ãƒƒãƒ€ãƒ¼ã«ã‚µãƒ¼ãƒãƒ¼å´ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°æƒ…å ±ã‚’è¿½åŠ 
    await next();
    
    const processingTime = Date.now() - requestStartTime;
    
    // ãƒ˜ãƒƒãƒ€ãƒ¼ã«ã‚µãƒ¼ãƒãƒ¼å‡¦ç†æ™‚é–“ã‚’è¿½åŠ 
    c.res.headers.append('Server-Timing', `total;dur=${processingTime}`);
    
    // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ­ã‚°ã®è¨˜éŒ²ï¼ˆæœ¬ç•ªã§ã¯é©åˆ‡ãªãƒ­ã‚®ãƒ³ã‚°ã‚µãƒ¼ãƒ“ã‚¹ã«é€ä¿¡ï¼‰
    if (processingTime > 1000) { // 1ç§’ä»¥ä¸Šã‹ã‹ã£ãŸãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è¨˜éŒ²
      console.warn(`Slow request: ${method} ${url} took ${processingTime}ms`);
    }
    
    // åˆ†æã®ãŸã‚ã«ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ‡ãƒ¼ã‚¿ã‚’KVã«ä¿å­˜
    try {
      const performanceData = {
        timestamp: new Date().toISOString(),
        url,
        method,
        processingTime,
        // ãã®ä»–ã®æœ‰ç”¨ãªæƒ…å ±ï¼ˆãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚µã‚¤ã‚ºã€ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚µã‚¤ã‚ºãªã©ï¼‰
      };
      
      // å®Ÿéš›ã®ç’°å¢ƒã§ã¯KVã‚„D1ãªã©ã«ä¿å­˜
      // await c.env.PERFORMANCE_KV.put(
      //   `perf_${Date.now()}_${Math.random().toString(36).substring(2, 9)}`,
      //   JSON.stringify(performanceData),
      //   { expirationTtl: 60 * 60 * 24 * 7 } // 1é€±é–“ä¿æŒ
      // );
    } catch (error) {
      console.error('Performance data logging failed:', error);
    }
  };
}
```

## ç¶™ç¶šçš„ãªæœ€é©åŒ–

### è‡ªå‹•ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ¸¬å®šã¨ã‚¢ãƒ©ãƒ¼ãƒˆ

```typescript
// src/server/tasks/performance-monitoring.ts
import { PerformanceMetric, ThresholdType } from '@/types/performance';

interface PerformanceThreshold {
  metric: string;
  warning: number;
  critical: number;
  type: ThresholdType; // 'lessThan' | 'greaterThan'
}

// ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã—ãã„å€¤ã®è¨­å®š
const performanceThresholds: PerformanceThreshold[] = [
  { metric: 'LCP', warning: 2500, critical: 4000, type: 'lessThan' },
  { metric: 'FID', warning: 100, critical: 300, type: 'lessThan' },
  { metric: 'CLS', warning: 0.1, critical: 0.25, type: 'lessThan' },
  { metric: 'TTFB', warning: 600, critical: 1000, type: 'lessThan' },
  { metric: 'apiResponseTime', warning: 200, critical: 500, type: 'lessThan' },
];

// ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã®è©•ä¾¡
export function evaluatePerformanceMetrics(metrics: PerformanceMetric[]) {
  const issues: {
    metric: string;
    value: number;
    threshold: number;
    severity: 'warning' | 'critical';
  }[] = [];
  
  metrics.forEach((metric) => {
    const threshold = performanceThresholds.find(t => t.metric === metric.name);
    
    if (!threshold) return;
    
    const isIssue = threshold.type === 'lessThan' 
      ? metric.value > threshold.warning 
      : metric.value < threshold.warning;
    
    const isCritical = threshold.type === 'lessThan' 
      ? metric.value > threshold.critical 
      : metric.value < threshold.critical;
    
    if (isIssue) {
      issues.push({
        metric: metric.name,
        value: metric.value,
        threshold: isCritical ? threshold.critical : threshold.warning,
        severity: isCritical ? 'critical' : 'warning'
      });
    }
  });
  
  return issues;
}

// ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®å•é¡Œã«å¯¾ã™ã‚‹ã‚¢ãƒ©ãƒ¼ãƒˆ
export async function alertOnPerformanceIssues(issues: any[]) {
  if (issues.length === 0) return;
  
  const criticalIssues = issues.filter(issue => issue.severity === 'critical');
  
  // æ·±åˆ»ãªå•é¡ŒãŒã‚ã‚‹å ´åˆã¯å³æ™‚é€šçŸ¥
  if (criticalIssues.length > 0) {
    await notifyTeam({
      title: `ğŸš¨ é‡å¤§ãªãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å•é¡ŒãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ`,
      message: `${criticalIssues.length}ä»¶ã®é‡å¤§ãªãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å•é¡ŒãŒç™ºç”Ÿã—ã¦ã„ã¾ã™ã€‚`,
      issues: criticalIssues,
      severity: 'critical'
    });
  } 
  // è­¦å‘Šãƒ¬ãƒ™ãƒ«ã®å•é¡Œã¯é›†ç´„ã—ã¦é€šçŸ¥
  else if (issues.length > 0) {
    await notifyTeam({
      title: `âš ï¸ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è­¦å‘Š`,
      message: `${issues.length}ä»¶ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è­¦å‘ŠãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚`,
      issues,
      severity: 'warning'
    });
  }
}

// ãƒãƒ¼ãƒ ã¸ã®é€šçŸ¥å‡¦ç†ï¼ˆå®Ÿéš›ã®å®Ÿè£…ã¯ç’°å¢ƒã«ã‚ˆã£ã¦ç•°ãªã‚‹ï¼‰
async function notifyTeam(notification: any) {
  // å®Ÿéš›ã®ã‚¢ãƒ©ãƒ¼ãƒˆå‡¦ç†ï¼ˆSlackã‚„é›»å­ãƒ¡ãƒ¼ãƒ«ãªã©ï¼‰
  console.log('Performance Alert:', notification);
  
  // ä¾‹: Slacké€šçŸ¥
  // await fetch(process.env.SLACK_WEBHOOK_URL, {
  //   method: 'POST',
  //   headers: { 'Content-Type': 'application/json' },
  //   body: JSON.stringify({
  //     text: notification.title,
  //     blocks: [
  //       {
  //         type: 'section',
  //         text: { type: 'mrkdwn', text: notification.message }
  //       },
  //       {
  //         type: 'section',
  //         text: {
  //           type: 'mrkdwn',
  //           text: notification.issues.map(issue => 
  //             `â€¢ *${issue.metric}*: ${issue.value}ms (é–¾å€¤: ${issue.threshold}ms)`
  //           ).join('\n')
  //         }
  //       }
  //     ]
  //   })
  // });
}
```

### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ¬ãƒãƒ¼ãƒˆã¨ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰

```typescript
// src/server/routes/admin/performance.ts
import { Router } from 'express';
import { getPerformanceData, generatePerformanceReport } from '../../services/performanceService';
import { isAdmin } from '../../middleware/auth';

const router = Router();

// ç®¡ç†è€…å‘ã‘ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
router.get('/dashboard', isAdmin, async (req, res) => {
  try {
    const { startDate, endDate } = req.query;
    
    const performanceData = await getPerformanceData({
      startDate: startDate ? new Date(startDate as string) : undefined,
      endDate: endDate ? new Date(endDate as string) : undefined
    });
    
    res.json({ data: performanceData });
  } catch (error) {
    console.error('Failed to fetch performance data:', error);
    res.status(500).json({ error: 'Failed to fetch performance data' });
  }
});

// ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ¬ãƒãƒ¼ãƒˆã®ç”Ÿæˆ
router.post('/report', isAdmin, async (req, res) => {
  try {
    const { startDate, endDate, metrics } = req.body;
    
    if (!startDate || !endDate) {
      return res.status(400).json({ error: 'æœŸé–“ã‚’æŒ‡å®šã—ã¦ãã ã•ã„' });
    }
    
    const report = await generatePerformanceReport({
      startDate: new Date(startDate),
      endDate: new Date(endDate),
      metrics: metrics || ['LCP', 'FID', 'CLS', 'TTFB', 'apiResponseTime']
    });
    
    res.json({ report });
  } catch (error) {
    console.error('Failed to generate performance report:', error);
    res.status(500).json({ error: 'Failed to generate performance report' });
  }
});

export default router;
```

### ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãƒ™ãƒ¼ã‚¹ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ¸¬å®š

```tsx
// src/components/common/PerformanceTracker.tsx
import React, { useEffect } from 'react';

interface PerformanceTrackerProps {
  componentName: string;
  children: React.ReactNode;
  onRenderComplete?: (duration: number) => void;
}

export const PerformanceTracker: React.FC<PerformanceTrackerProps> = ({ 
  componentName, 
  children,
  onRenderComplete 
}) => {
  useEffect(() => {
    const startTime = performance.now();
    
    return () => {
      const endTime = performance.now();
      const duration = endTime - startTime;
      
      // ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°æ™‚é–“ã‚’è¨˜éŒ²
      console.debug(`Component '${componentName}' rendered in ${duration.toFixed(2)}ms`);
      
      // å¿…è¦ã«å¿œã˜ã¦åˆ†æã‚µãƒ¼ãƒ“ã‚¹ã«é€ä¿¡
      if (onRenderComplete) {
        onRenderComplete(duration);
      }
      
      // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚¨ãƒ³ãƒˆãƒªã‚’ä½œæˆï¼ˆé–‹ç™ºãƒ»ãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
      if (process.env.NODE_ENV === 'development') {
        performance.mark(`${componentName}-end`);
        try {
          performance.measure(
            `${componentName}-render`,
            `${componentName}-start`,
            `${componentName}-end`
          );
        } catch (e) {
          // ãƒãƒ¼ã‚¯ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã«ä¾‹å¤–ãŒç™ºç”Ÿã™ã‚‹ãŸã‚æ•æ‰
          console.debug(`Could not measure performance for ${componentName}`);
        }
      }
    };
  }, [componentName, onRenderComplete]);
  
  useEffect(() => {
    // ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°é–‹å§‹ã‚’ãƒãƒ¼ã‚¯
    if (process.env.NODE_ENV === 'development') {
      performance.mark(`${componentName}-start`);
    }
  }, [componentName]);
  
  return <>{children}</>;
};
```

## ã¾ã¨ã‚

ã“ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ã‚¬ã‚¤ãƒ‰ã§ã¯ã€ãƒãƒãƒã‚±ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ã•ã¾ã–ã¾ãªå´é¢ã§ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸Šç­–ã‚’ç´¹ä»‹ã—ã¾ã—ãŸã€‚ã“ã‚Œã‚‰ã®æœ€é©åŒ–ã‚’é©ç”¨ã™ã‚‹ã“ã¨ã§ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¨ã‚¯ã‚¹ãƒšãƒªã‚¨ãƒ³ã‚¹ã®å‘ä¸Šã¨ãƒªã‚½ãƒ¼ã‚¹ä½¿ç”¨ã®åŠ¹ç‡åŒ–ã‚’å®Ÿç¾ã§ãã¾ã™ã€‚

é‡è¦ãªãƒã‚¤ãƒ³ãƒˆï¼š

1. **æ¸¬å®šãŒæœ€é©åŒ–ã®ç¬¬ä¸€æ­©** - å®Ÿéš›ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’æ¸¬å®šã—ã€ãƒœãƒˆãƒ«ãƒãƒƒã‚¯ã‚’ç‰¹å®šã™ã‚‹ã“ã¨ãŒé‡è¦ã§ã™ã€‚

2. **æ®µéšçš„ãªæœ€é©åŒ–** - ã™ã¹ã¦ã®æœ€é©åŒ–ã‚’ä¸€åº¦ã«é©ç”¨ã™ã‚‹ã®ã§ã¯ãªãã€æ¸¬å®šçµæœã«åŸºã¥ã„ã¦å„ªå…ˆé †ä½ã‚’ã¤ã‘ã¦æ®µéšçš„ã«å®Ÿè£…ã—ã¾ã—ã‚‡ã†ã€‚

3. **ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ã‚’å„ªå…ˆ** - æŠ€è¡“çš„ãªãƒ¡ãƒˆãƒªã‚¯ã‚¹ã ã‘ã§ãªãã€å®Ÿéš›ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ã‚’å„ªå…ˆã—ã¦æœ€é©åŒ–ã‚’è¡Œã„ã¾ã™ã€‚

4. **ç¶™ç¶šçš„ãªãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°** - ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã¯ç¶™ç¶šçš„ã«ç›£è¦–ã—ã€æ–°æ©Ÿèƒ½ã®è¿½åŠ ã‚„å¤‰æ›´ã«ã‚ˆã‚‹ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã¸ã®å½±éŸ¿ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¾ã™ã€‚

5. **é©åˆ‡ãªãƒˆãƒ¬ãƒ¼ãƒ‰ã‚ªãƒ•** - æ©Ÿèƒ½ã®è±Šå¯Œã•ã¨ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®ãƒãƒ©ãƒ³ã‚¹ã‚’å–ã‚Šã€é©åˆ‡ãªãƒˆãƒ¬ãƒ¼ãƒ‰ã‚ªãƒ•ã‚’æ¤œè¨ã—ã¾ã—ã‚‡ã†ã€‚

ã“ã®ã‚¬ã‚¤ãƒ‰ã‚’å‚è€ƒã«ã€ãƒãƒãƒã‚±ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’ç¶™ç¶šçš„ã«æ”¹å–„ã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å„ªã‚ŒãŸä½“é¨“ã‚’æä¾›ã—ã¦ãã ã•ã„ã€‚
import ReactDOMServer from 'react-dom/server';
import { StaticRouter } from 'react-router/server';
import { App } from './App';

export function render(url: string, context: any) {
  return ReactDOMServer.renderToString(
    <StaticRouter location={url} context={context}>
      <App />
    </StaticRouter>
  );
}
```

```tsx
// entry-client.tsx
import React from 'react';
import ReactDOM from 'react-dom/client';
import { BrowserRouter } from 'react-router';
import { App } from './App';

ReactDOM.hydrateRoot(
  document.getElementById('app')!,
  <BrowserRouter>
    <App />
  </BrowserRouter>
);
```

### é¸æŠçš„ãƒã‚¤ãƒ‰ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³

å¤§è¦æ¨¡ãªãƒšãƒ¼ã‚¸ã§ã¯React 18ã®é¸æŠçš„ãƒã‚¤ãƒ‰ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ´»ç”¨ã—ã¦ã€ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã‚’æœ€é©åŒ–ã—ã¾ã™ï¼š

```jsx
import { Suspense } from 'react';

function HomePage() {
  return (
    <div>
      <Header />
      <Suspense fallback={<MapPlaceholder />}>
        <MapComponent priority="high" />
      </Suspense>
      <Suspense fallback={<SpotListSkeleton />}>
        <PopularSpots />
      </Suspense>
      <Footer />
    </div>
  );
}
```

### ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰ã¨ãƒ—ãƒªãƒ•ã‚§ãƒƒãƒ

é·ç§»ã®é«˜é€ŸåŒ–ã®ãŸã‚ã«ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰ã¨ãƒ—ãƒªãƒ•ã‚§ãƒƒãƒã‚’å®Ÿè£…ã—ã¾ã™ï¼š

```jsx
import { useCallback, useEffect } from 'react';
import { Link, useLocation } from 'react-router';

function NavLink({ to, children, prefetch = false }) {
  const prefetchLink = useCallback(() => {
    // ãƒªãƒ³ã‚¯å…ˆã®ãƒªã‚½ãƒ¼ã‚¹ã‚’ãƒ—ãƒªãƒ•ã‚§ãƒƒãƒ
    const prefetcher = document.createElement('link');
    prefetcher.rel = 'prefetch';
    prefetcher.href = to;
    document.head.appendChild(prefetcher);
  }, [to]);

  return (
    <Link 
      to={to} 
      onMouseEnter={prefetch ? prefetchLink : undefined}
      onFocus={prefetch ? prefetchLink : undefined}
    >
      {children}
    </Link>
  );
}