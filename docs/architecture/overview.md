# マチポケ - アーキテクチャ概要

## システム構成

「マチポケ」は、地元の人だけが知る隠れた場所を共有するプラットフォームとして設計されています。システムは主に以下のコンポーネントで構成されています。

```mermaid
graph TD
    User[ユーザー] --> CDN[Cloudflare CDN]
    CDN --> Frontend[フロントエンド\n(React)]
    CDN --> Backend[バックエンド\n(Hono)]
    Frontend <-->|GraphQL| Backend
    Backend --> D1[Cloudflare D1\n(リレーショナル)]
    Backend --> KV[Cloudflare KV\n(キャッシュ)]
    Backend --> R2[Cloudflare R2\n(画像)]
```

## アーキテクチャの特徴

### モノレポ構成
プロジェクトはモノレポとして管理され、フロントエンド、バックエンド、共有モジュールなどを統一的に開発できる構成となっています。

### クラウドネイティブ設計
- **Cloudflare Workers**: サーバーレスコンピューティング環境を活用し、スケーラブルかつ低レイテンシーのバックエンドを実現
- **エッジコンピューティング**: ユーザーに近い場所でコードを実行することで、高速なレスポンスを確保

### マイクロサービスとモノリス間のバランス
- モノリシックなコードベースの管理性と、マイクロサービス的な分離の利点を融合
- ドメイン駆動設計（DDD）を採用し、機能ごとの分離と再利用性を高めたバックエンド設計

## 主要技術スタック

### フロントエンド
- **React + React Router v7**: モダンなコンポーネントベースUIライブラリとルーティング
- **Server-Side Rendering (SSR)**: 初期ロード時のパフォーマンス向上とSEO対策
- **Mapbox/Leaflet**: 地図表示機能の実装
- **Progressive Web App (PWA)**: オフラインでも利用可能な機能

### バックエンド
- **Hono**: 軽量かつ高速なWebフレームワーク (Cloudflare Workers向け)
- **GraphQL**: 柔軟なAPIクエリとデータ取得の効率化
- **Cloudflare D1**: SQLiteベースのリレーショナルデータベース
- **Cloudflare KV**: 高速なキー/バリューストア (キャッシュや設定データ向け)
- **Cloudflare R2**: S3互換のオブジェクトストレージ (画像・メディア向け)

## データフロー

1. ユーザーがブラウザからアプリケーションにアクセス
2. フロントエンドアプリケーションがレンダリングされる (SSR + クライアント側ハイドレーション)
3. フロントエンドがGraphQL APIを通じてバックエンドと通信
4. バックエンドはビジネスロジックを処理し、適切なデータストアにアクセス
   - ユーザー情報、スポットデータ: D1
   - セッション情報、キャッシュ: KV
   - 画像、添付ファイル: R2
5. 処理結果がGraphQLレスポンスとしてフロントエンドに返される

## スケーラビリティ考慮事項

- **エッジコンピューティング**: Cloudflare Workersの世界中のエッジノードを活用
- **データベースシャーディング**: 将来的な拡張時のためのD1データ設計
- **コンテンツデリバリー**: Cloudflare CDNによる静的アセットの最適化配信
- **コールドスタート回避**: Workersの特性を考慮した設計

## セキュリティアーキテクチャ

- **認証**: Cloudflare AccessまたはAuth0との連携
- **認可**: ロールベースアクセス制御とリソースレベルの権限管理
- **データ保護**: 必要最小限のデータ収集と暗号化
- **API保護**: レート制限とトークン検証

## 開発・デプロイメントパイプライン

- **CI/CD**: GitHub Actionsを活用した自動テスト・デプロイ
- **環境分離**: 開発、ステージング、本番環境の分離
- **デプロイ戦略**: Cloudflare Workersの特性を活かした段階的ロールアウト

## 将来的な拡張性

- **多言語対応**: 国際的なユーザーベースへの拡張
- **推奨エンジン**: ユーザー好みに基づくスポット推奨機能
- **モバイルアプリ連携**: PWA以外のネイティブアプリ対応への拡張性
- **APIエコシステム**: 外部サービスとの連携のためのAPI拡張